<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1, width=device-width"/>
  <title>Zonear e Pesquisar Endere√ßos - Mapbox</title>

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Mapbox GL Draw -->
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>

  <!-- Geocoder -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.2/mapbox-gl-geocoder.css" type="text/css"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.2/mapbox-gl-geocoder.min.js"></script>

  <!-- Turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { position: absolute; top: 60px; bottom: 0; width: 100%; }
    .topbar {
      position: absolute; top: 0; left: 0; right: 0; height: 60px; display: flex; align-items: center; gap: 12px;
      padding: 8px 12px; background: #111827; color: #f9fafb; z-index: 10;
    }
    .topbar .pill { background:#1f2937; padding:6px 10px; border-radius:8px; font-size: 12px; }
    .geocoder-container {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 350px;
      z-index: 10;
    }
    .search-box {
      background: white;
      border-radius: 8px;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      overflow: hidden;
    }
    .search-input {
      width: 100%;
      height: 40px;
      border: none;
      padding: 0 12px;
      font-size: 14px;
      outline: none;
      box-sizing: border-box;
    }
    .search-results {
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: none;
    }
    .search-result-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
      line-height: 1.4;
    }
    .search-result-item:hover {
      background: #f9fafb;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-name {
      font-weight: 600;
      color: #111827;
    }
    .search-result-address {
      color: #6b7280;
      margin-top: 2px;
    }
    .notice {
      position: absolute; top: 70px; right: 12px; background: #111827; color:#fff; padding: 8px 10px; border-radius: 8px; z-index: 10;
      box-shadow: 0 6px 16px rgba(0,0,0,.2); display:none;
    }
    .btn {
      background:#2563eb; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .btn.secondary { background:#374151; }
    .pricing-panel {
      position: absolute;
      top: 70px;
      left: 12px;
      width: 280px;
      background: #111827;
      color: #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      z-index: 10;
      display: none;
    }
    .pricing-header {
      padding: 12px 16px;
      border-bottom: 1px solid #374151;
      font-weight: 600;
      font-size: 14px;
    }
    .pricing-content {
      padding: 12px 16px;
      max-height: 300px;
      overflow-y: auto;
    }
    .pricing-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .pricing-label {
      flex: 1;
      color: #d1d5db;
    }
    .pricing-input {
      width: 80px;
      padding: 4px 8px;
      border: 1px solid #374151;
      border-radius: 6px;
      background: #1f2937;
      color: #e5e7eb;
      font-size: 12px;
      text-align: right;
    }
    .pricing-input:focus {
      outline: none;
      border-color: #2563eb;
    }
    .pricing-actions {
      padding: 12px 16px;
      border-top: 1px solid #374151;
      display: flex;
      gap: 8px;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-primary { background: #2563eb; color: white; }
    .btn-success { background: #059669; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .pricing-info {
      margin-top: 8px;
      padding: 8px;
      background: #1f2937;
      border-radius: 6px;
      font-size: 11px;
      color: #9ca3af;
    }
    .legend {
      position:absolute; bottom:60px; left:12px; background:#111827; color:#e5e7eb; padding:10px 12px; border-radius:10px; z-index:10; font-size: 13px;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .legend code { background:#1f2937; padding:1px 6px; border-radius:6px; }
    /* Geocoder container tweak */
    .mapboxgl-ctrl-top-right .mapboxgl-ctrl { margin: 6px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="pill">1) Desenhe uma <b>zona</b> (pol√≠gono) no mapa</div>
    <div class="pill">2) Pesquise um endere√ßo no campo da direita</div>
    <button id="btnClear" class="btn secondary" title="Limpar zona">Limpar zona</button>
    <button id="btnExport" class="btn secondary" title="Exportar GeoJSON da zona">Exportar GeoJSON</button>
    <button id="btnImport" class="btn secondary" title="Carregar zona de arquivo">Carregar zona</button>
    <button id="btnPricing" class="btn secondary" title="Configurar precifica√ß√£o">Precifica√ß√£o</button>
    <input type="file" id="fileInput" accept=".geojson,.json" style="display: none;">
  </div>

  <!-- Painel de Precifica√ß√£o -->
  <div id="pricing-panel" class="pricing-panel">
    <div class="pricing-header">
      Configura√ß√£o de Pre√ßos por Dist√¢ncia
    </div>
    <div class="pricing-content">
      <div class="pricing-row">
        <span class="pricing-label">0 - 1 km:</span>
        <input type="number" class="pricing-input" id="price-1" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="pricing-row">
        <span class="pricing-label">1 - 2 km:</span>
        <input type="number" class="pricing-input" id="price-2" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="pricing-row">
        <span class="pricing-label">2 - 3 km:</span>
        <input type="number" class="pricing-input" id="price-3" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="pricing-row">
        <span class="pricing-label">3 - 4 km:</span>
        <input type="number" class="pricing-input" id="price-4" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="pricing-row">
        <span class="pricing-label">4 - 5 km:</span>
        <input type="number" class="pricing-input" id="price-5" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="pricing-row">
        <span class="pricing-label">5 - 6 km:</span>
        <input type="number" class="pricing-input" id="price-6" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="pricing-row">
        <span class="pricing-label">6 - 7 km:</span>
        <input type="number" class="pricing-input" id="price-7" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="pricing-info">
        üí° Clique no mapa para definir o ponto central de precifica√ß√£o. Os c√≠rculos mostrar√£o as zonas de pre√ßo.
      </div>
    </div>
    <div class="pricing-actions">
      <button id="btnShowZones" class="btn-small btn-primary">Mostrar Zonas</button>
      <button id="btnHideZones" class="btn-small btn-danger">Ocultar</button>
      <button id="btnSavePricing" class="btn-small btn-success">Salvar</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="notice" class="notice"></div>
  <div id="geocoder-container" class="geocoder-container">
    <div class="search-box">
      <input type="text" id="search-input" class="search-input" placeholder="Pesquisar endere√ßo na √°rea demarcada...">
      <div id="search-results" class="search-results"></div>
    </div>
  </div>

  <div class="legend">
    <div><b>Dicas r√°pidas</b></div>
    <div>‚Ä¢ Clique no √≠cone de <b>pol√≠gono</b> para desenhar a zona.</div>
    <div>‚Ä¢ Clique nos v√©rtices para <b>editar</b>. Pressione <code>Del</code> para apagar.</div>
    <div>‚Ä¢ Use <b>Carregar zona</b> para importar um arquivo GeoJSON.</div>
    <div>‚Ä¢ Use <b>Precifica√ß√£o</b> para configurar pre√ßos por dist√¢ncia.</div>
    <div>‚Ä¢ A busca s√≥ aceita <b>resultados dentro da zona</b>.</div>
  </div>

  <script>
    // ==== CONFIG ====
    mapboxgl.accessToken = 'pk.eyJ1Ijoic3VwcmVtb3dpbGwiLCJhIjoiY21keHUydHM2MDEzYjJqcHMyNjlkbWVvbyJ9.FTzTaKQvyAZ3ihSNyAYFGg';

    // ==== MAPA ====
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-51.9345, -23.4200], // centro aproximado PR
      zoom: 11
    });

    // Marker p/ resultado
    let resultMarker = null;
    
    // ==== SISTEMA DE PRECIFICA√á√ÉO ====
    let pricingCenter = null;
    let pricingZones = [];
    let pricingVisible = false;
    
    const defaultPrices = {
      1: 10.00,
      2: 15.00,
      3: 20.00,
      4: 25.00,
      5: 30.00,
      6: 35.00,
      7: 40.00
    };
    
    const zoneColors = [
      '#ef4444', // 1km - vermelho
      '#f97316', // 2km - laranja
      '#eab308', // 3km - amarelo
      '#22c55e', // 4km - verde
      '#06b6d4', // 5km - ciano
      '#3b82f6', // 6km - azul
      '#8b5cf6'  // 7km - roxo
    ];

    // ==== DRAW (zona) ====
    const Draw = new MapboxDraw({
      displayControlsDefault: false,
      controls: { polygon: true, trash: true },
      defaultMode: 'draw_polygon',
      styles: [
        // fill
        {
          "id": "gl-draw-polygon-fill",
          "type": "fill",
          "filter": ["all", ["==", "$type", "Polygon"], ["!=", "mode", "static"]],
          "paint": { "fill-color": "#3b82f6", "fill-opacity": 0.15 }
        },
        // outline
        {
          "id": "gl-draw-polygon-stroke",
          "type": "line",
          "filter": ["all", ["==", "$type", "Polygon"], ["!=", "mode", "static"]],
          "paint": { "line-color": "#2563eb", "line-width": 2 }
        },
        // vertex
        {
          "id": "gl-draw-polygon-and-line-vertex-halo-active",
          "type": "circle",
          "filter": ["all", ["==", "active", "true"], ["==", "$type", "Point"], ["==", "meta", "vertex"]],
          "paint": { "circle-radius": 7, "circle-color": "#fff" }
        },
        {
          "id": "gl-draw-polygon-and-line-vertex-active",
          "type": "circle",
          "filter": ["all", ["==", "active", "true"], ["==", "$type", "Point"], ["==", "meta", "vertex"]],
          "paint": { "circle-radius": 5, "circle-color": "#2563eb" }
        }
      ]
    });
    map.addControl(Draw, 'top-left');

    // ==== SISTEMA DE BUSCA PERSONALIZADO ====
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    let searchTimeout;

    // Fun√ß√£o para buscar endere√ßos
    async function searchAddresses(query) {
      if (!query || query.length < 3) {
        hideSearchResults();
        return;
      }

      try {
        // Constr√≥i a URL da API do Mapbox Geocoding
        const poly = getCurrentZonePolygon();
        console.log('Zona atual na busca:', poly); // Debug
        
        let url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&country=br&language=pt&limit=10`;
        
        // Se h√° uma zona demarcada, aplica bbox
        if (poly) {
          const bbox = turf.bbox(poly);
          console.log('Bbox calculado:', bbox); // Debug
          url += `&bbox=${bbox.join(',')}`;
        }

        console.log('URL de busca:', url); // Debug
        const response = await fetch(url);
        const data = await response.json();
        console.log('Resultados da API:', data); // Debug
        
        if (data.features && data.features.length > 0) {
          // Filtra resultados que est√£o dentro da zona (se existir)
          let filteredResults = data.features;
          if (poly) {
            filteredResults = data.features.filter(feature => {
              if (!feature.center) return false;
              const point = turf.point(feature.center);
              const isInside = turf.booleanPointInPolygon(point, poly);
              console.log(`Endere√ßo ${feature.place_name} est√° dentro da zona: ${isInside}`); // Debug
              return isInside;
            });
          }
          
          console.log('Resultados filtrados:', filteredResults); // Debug
          displaySearchResults(filteredResults);
        } else {
          displayNoResults();
        }
      } catch (error) {
        console.error('Erro na busca:', error);
        displayNoResults();
      }
    }

    // Exibe os resultados da busca
    function displaySearchResults(results) {
      if (results.length === 0) {
        displayNoResults();
        return;
      }

      const html = results.map(feature => {
        const name = feature.text || feature.place_name?.split(',')[0] || 'Endere√ßo';
        const address = feature.place_name || 'Endere√ßo n√£o especificado';
        
        return `
          <div class="search-result-item" data-lng="${feature.center[0]}" data-lat="${feature.center[1]}" data-name="${address}">
            <div class="search-result-name">${name}</div>
            <div class="search-result-address">${address}</div>
          </div>
        `;
      }).join('');

      searchResults.innerHTML = html;
      searchResults.style.display = 'block';

      // Adiciona eventos de clique nos resultados
      searchResults.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const lng = parseFloat(item.dataset.lng);
          const lat = parseFloat(item.dataset.lat);
          const name = item.dataset.name;
          selectAddress(lng, lat, name);
        });
      });
    }

    // Exibe mensagem quando n√£o h√° resultados
    function displayNoResults() {
      const poly = getCurrentZonePolygon();
      const message = poly ? 
        'Nenhum endere√ßo encontrado na √°rea demarcada' : 
        'Nenhum endere√ßo encontrado';
      
      searchResults.innerHTML = `
        <div class="search-result-item" style="color: #6b7280; cursor: default;">
          ${message}
        </div>
      `;
      searchResults.style.display = 'block';
    }

    // Esconde os resultados
    function hideSearchResults() {
      searchResults.style.display = 'none';
    }

    // Seleciona um endere√ßo
    function selectAddress(lng, lat, name) {
      clearMarker();
      resultMarker = new mapboxgl.Marker({ color: '#2563eb' })
        .setLngLat([lng, lat])
        .addTo(map);
      
      map.flyTo({ 
        center: [lng, lat], 
        zoom: Math.max(map.getZoom(), 16),
        duration: 1000
      });
      
      searchInput.value = name;
      hideSearchResults();
      
      // Calcula pre√ßo se h√° sistema de precifica√ß√£o ativo
      const pricing = calculatePrice(lng, lat);
      
      const poly = getCurrentZonePolygon();
      if (poly) {
        if (pricing.price > 0) {
          showNotice(`Endere√ßo selecionado! Zona ${pricing.zone} - Dist√¢ncia: ${pricing.distance}km - Pre√ßo: R$ ${pricing.price.toFixed(2)}`, 4000);
        } else {
          showNotice('Endere√ßo selecionado dentro da zona!', 2000);
        }
      } else {
        if (pricing.price > 0) {
          showNotice(`Endere√ßo selecionado! Zona ${pricing.zone} - Dist√¢ncia: ${pricing.distance}km - Pre√ßo: R$ ${pricing.price.toFixed(2)}`, 4000);
        } else {
          showNotice('Endere√ßo selecionado!', 2000);
        }
      }
      
      console.log('Endere√ßo selecionado:', { lng, lat, name, pricing });
    }

    // ==== SISTEMA DE PRECIFICA√á√ÉO - FUN√á√ïES ====
    
    function initializePricing() {
      // Carrega pre√ßos salvos ou usa padr√µes
      const savedPrices = localStorage.getItem('pricingZones');
      const prices = savedPrices ? JSON.parse(savedPrices) : defaultPrices;
      
      for (let i = 1; i <= 7; i++) {
        document.getElementById(`price-${i}`).value = prices[i] || '';
      }
      
      // Carrega centro salvo
      const savedCenter = localStorage.getItem('pricingCenter');
      if (savedCenter) {
        pricingCenter = JSON.parse(savedCenter);
      }
    }
    
    function savePricing() {
      const prices = {};
      for (let i = 1; i <= 7; i++) {
        const value = parseFloat(document.getElementById(`price-${i}`).value);
        if (!isNaN(value) && value > 0) {
          prices[i] = value;
        }
      }
      
      localStorage.setItem('pricingZones', JSON.stringify(prices));
      if (pricingCenter) {
        localStorage.setItem('pricingCenter', JSON.stringify(pricingCenter));
      }
      
      showNotice('Configura√ß√£o de pre√ßos salva!', 2000);
    }
    
    function createPricingZones(centerLng, centerLat) {
      clearPricingZones();
      
      pricingCenter = [centerLng, centerLat];
      
      // Cria c√≠rculos para cada zona de pre√ßo
      for (let i = 1; i <= 7; i++) {
        const radius = i; // raio em km
        const circle = turf.circle([centerLng, centerLat], radius, {
          steps: 64,
          units: 'kilometers'
        });
        
        const price = parseFloat(document.getElementById(`price-${i}`).value) || 0;
        
        // Adiciona propriedades ao c√≠rculo
        circle.properties = {
          zone: i,
          price: price,
          radius: radius,
          color: zoneColors[i-1]
        };
        
        pricingZones.push(circle);
      }
      
      if (pricingVisible) {
        showPricingZones();
      }
    }
    
    function showPricingZones() {
      if (pricingZones.length === 0) {
        showNotice('Defina um ponto central clicando no mapa primeiro.', 3000);
        return;
      }
      
      // Remove zonas existentes
      hidePricingZones();
      
      pricingZones.forEach((zone, index) => {
        const sourceId = `pricing-zone-${zone.properties.zone}`;
        const layerId = `pricing-layer-${zone.properties.zone}`;
        
        // Adiciona source
        map.addSource(sourceId, {
          type: 'geojson',
          data: zone
        });
        
        // Adiciona layer de preenchimento
        map.addLayer({
          id: layerId,
          type: 'fill',
          source: sourceId,
          paint: {
            'fill-color': zone.properties.color,
            'fill-opacity': 0.1
          }
        });
        
        // Adiciona layer de borda
        map.addLayer({
          id: `${layerId}-stroke`,
          type: 'line',
          source: sourceId,
          paint: {
            'line-color': zone.properties.color,
            'line-width': 2,
            'line-opacity': 0.8
          }
        });
      });
      
      // Adiciona marcador no centro
      if (pricingCenter) {
        if (resultMarker) resultMarker.remove();
        resultMarker = new mapboxgl.Marker({ color: '#dc2626' })
          .setLngLat(pricingCenter)
          .addTo(map);
      }
      
      pricingVisible = true;
      showNotice('Zonas de precifica√ß√£o exibidas!', 2000);
    }
    
    function hidePricingZones() {
      pricingZones.forEach((zone) => {
        const layerId = `pricing-layer-${zone.properties.zone}`;
        const strokeId = `${layerId}-stroke`;
        const sourceId = `pricing-zone-${zone.properties.zone}`;
        
        if (map.getLayer(layerId)) map.removeLayer(layerId);
        if (map.getLayer(strokeId)) map.removeLayer(strokeId);
        if (map.getSource(sourceId)) map.removeSource(sourceId);
      });
      
      pricingVisible = false;
    }
    
    function clearPricingZones() {
      hidePricingZones();
      pricingZones = [];
    }
    
    function calculatePrice(lng, lat) {
      if (!pricingCenter || pricingZones.length === 0) {
        return { zone: 0, price: 0, distance: 0 };
      }
      
      const point = turf.point([lng, lat]);
      const center = turf.point(pricingCenter);
      const distance = turf.distance(center, point, { units: 'kilometers' });
      
      // Encontra a zona correspondente
      for (let i = 1; i <= 7; i++) {
        if (distance <= i) {
          const price = parseFloat(document.getElementById(`price-${i}`).value) || 0;
          return { zone: i, price: price, distance: distance.toFixed(2) };
        }
      }
      
      // Se estiver al√©m de 7km
      return { zone: 8, price: 0, distance: distance.toFixed(2) };
    }

    // Eventos do input de busca
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchAddresses(query);
      }, 300); // Debounce de 300ms
    });

    // Esconde resultados ao clicar fora
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.geocoder-container')) {
        hideSearchResults();
      }
    });

    // Esconde resultados ao pressionar Escape
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideSearchResults();
        searchInput.blur();
      }
    });

    // ==== Helpers UI ====
    const notice = document.getElementById('notice');
    function showNotice(msg, ms = 2800) {
      notice.textContent = msg;
      notice.style.display = 'block';
      clearTimeout(showNotice._t);
      showNotice._t = setTimeout(() => notice.style.display = 'none', ms);
    }

    // ==== ZONA ATUAL ====
    function getCurrentZonePolygon() {
      const fc = Draw.getAll();
      if (!fc || !fc.features || fc.features.length === 0) return null;
      // s√≥ considera o primeiro pol√≠gono
      const poly = fc.features.find(f => f.geometry && f.geometry.type === 'Polygon');
      return poly || null;
    }

    function clearMarker() {
      if (resultMarker) {
        resultMarker.remove();
        resultMarker = null;
      }
    }

    // ==== CARREGAR ZONA DE ARQUIVO ====
    function loadZoneFromFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Limpa zonas existentes
          Draw.deleteAll();
          clearMarker();
          
          // Verifica se √© um FeatureCollection v√°lido
          if (data.type === 'FeatureCollection' && data.features) {
            // Adiciona todas as features que s√£o pol√≠gonos
            const polygons = data.features.filter(f => 
              f.geometry && f.geometry.type === 'Polygon'
            );
            
            if (polygons.length > 0) {
              // Adiciona apenas o primeiro pol√≠gono para manter a regra de uma zona
              Draw.add(polygons[0]);
              
              // Centraliza o mapa na zona carregada
              const bbox = turf.bbox(polygons[0]);
              map.fitBounds(bbox, { padding: 50 });
              
              // For√ßa a atualiza√ß√£o da fun√ß√£o de busca
              setTimeout(() => {
                updateGeocoderBBoxFromZone();
              }, 500);
              
              showNotice(`Zona carregada com sucesso! ${polygons.length > 1 ? '(Apenas a primeira zona foi carregada)' : ''} Agora voc√™ pode pesquisar endere√ßos na √°rea.`, 4000);
            } else {
              showNotice('Arquivo n√£o cont√©m pol√≠gonos v√°lidos.', 3000);
            }
          } 
          // Se √© um pol√≠gono individual
          else if (data.type === 'Feature' && data.geometry && data.geometry.type === 'Polygon') {
            Draw.add(data);
            
            // Centraliza o mapa na zona carregada
            const bbox = turf.bbox(data);
            map.fitBounds(bbox, { padding: 50 });
            
            // For√ßa a atualiza√ß√£o da fun√ß√£o de busca
            setTimeout(() => {
              updateGeocoderBBoxFromZone();
            }, 500);
            
            showNotice('Zona carregada com sucesso! Agora voc√™ pode pesquisar endere√ßos na √°rea.', 4000);
          }
          // Se √© um pol√≠gono direto (geometry only)
          else if (data.type === 'Polygon') {
            const feature = {
              type: 'Feature',
              geometry: data,
              properties: {}
            };
            Draw.add(feature);
            
            // Centraliza o mapa na zona carregada
            const bbox = turf.bbox(feature);
            map.fitBounds(bbox, { padding: 50 });
            
            // For√ßa a atualiza√ß√£o da fun√ß√£o de busca
            setTimeout(() => {
              updateGeocoderBBoxFromZone();
            }, 500);
            
            showNotice('Zona carregada com sucesso! Agora voc√™ pode pesquisar endere√ßos na √°rea.', 4000);
          } else {
            showNotice('Formato de arquivo n√£o suportado. Use um arquivo GeoJSON com pol√≠gonos.', 4000);
          }
          
        } catch (error) {
          console.error('Erro ao carregar arquivo:', error);
          showNotice('Erro ao processar arquivo. Verifique se √© um GeoJSON v√°lido.', 4000);
        }
      };
      
      reader.onerror = function() {
        showNotice('Erro ao ler arquivo.', 3000);
      };
      
      reader.readAsText(file);
    }

    function updateGeocoderBBoxFromZone() {
      const poly = getCurrentZonePolygon();
      if (poly) {
        console.log('Zona detectada para busca:', poly); // Debug
        showNotice('Zona definida. Digite no campo de busca para encontrar endere√ßos na √°rea.', 3000);
      } else {
        console.log('Nenhuma zona detectada'); // Debug
      }
    }

    function clearMarker() {
      if (resultMarker) {
        resultMarker.remove();
        resultMarker = null;
      }
    }

    // ==== Eventos do Draw ====
    map.on('load', () => {
      // Mapa carregado - inicializa precifica√ß√£o
      initializePricing();
    });

    map.on('draw.create', () => {
      // Garantir s√≥ UMA zona: apaga extras
      const fc = Draw.getAll();
      if (fc.features.length > 1) {
        // mant√©m o √∫ltimo pol√≠gono desenhado
        const lastId = fc.features[fc.features.length - 1].id;
        fc.features.forEach(f => { if (f.id !== lastId) Draw.delete(f.id); });
      }
      updateGeocoderBBoxFromZone();
    });
    map.on('draw.update', updateGeocoderBBoxFromZone);
    map.on('draw.delete', () => {
      showNotice('Zona removida. A busca volta a ser ampla.', 2500);
    });

    // ==== Geocoder: filtra sele√ß√£o para ficar DENTRO do pol√≠gono ====
    // Removido - agora usamos sistema pr√≥prio de busca

    // ==== Bot√µes ====
    document.getElementById('btnClear').addEventListener('click', () => {
      Draw.deleteAll();
      clearMarker();
    });

    document.getElementById('btnExport').addEventListener('click', () => {
      const fc = Draw.getAll();
      if (!fc.features.length) {
        showNotice('Nenhuma zona para exportar.');
        return;
      }
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fc, null, 2));
      const a = document.createElement('a');
      a.setAttribute("href", dataStr);
      a.setAttribute("download", "zona.geojson");
      document.body.appendChild(a);
      a.click();
      a.remove();
      showNotice('Arquivo zona.geojson baixado!', 2500);
    });

    document.getElementById('btnImport').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.name.toLowerCase().endsWith('.geojson') || file.name.toLowerCase().endsWith('.json')) {
          loadZoneFromFile(file);
        } else {
          showNotice('Por favor, selecione um arquivo .geojson ou .json', 3000);
        }
        // Limpa o input para permitir selecionar o mesmo arquivo novamente
        e.target.value = '';
      }
    });

    // ==== Eventos de Precifica√ß√£o ====
    document.getElementById('btnPricing').addEventListener('click', () => {
      const panel = document.getElementById('pricing-panel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });

    document.getElementById('btnShowZones').addEventListener('click', () => {
      showPricingZones();
    });

    document.getElementById('btnHideZones').addEventListener('click', () => {
      hidePricingZones();
    });

    document.getElementById('btnSavePricing').addEventListener('click', () => {
      savePricing();
    });

    // ==== Qualidade de vida: clique fora para esconder aviso ====
    map.on('click', (e) => { 
      notice.style.display = 'none';
      
      // Se o painel de precifica√ß√£o estiver aberto, permite definir ponto central
      const pricingPanel = document.getElementById('pricing-panel');
      if (pricingPanel.style.display === 'block') {
        const { lng, lat } = e.lngLat;
        createPricingZones(lng, lat);
        showNotice(`Ponto central definido: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 2500);
      }
    });

  </script>
</body>
</html>
