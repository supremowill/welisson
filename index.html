<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1, width=device-width"/>
  <title>Zonear e Pesquisar Endereços - Mapbox</title>

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Mapbox GL Draw -->
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>

  <!-- Geocoder -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.2/mapbox-gl-geocoder.css" type="text/css"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.2/mapbox-gl-geocoder.min.js"></script>

  <!-- Turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map { position: absolute; top: 60px; bottom: 0; width: 100%; }
    .topbar {
      position: absolute; top: 0; left: 0; right: 0; height: 60px; display: flex; align-items: center; gap: 12px;
      padding: 8px 12px; background: #111827; color: #f9fafb; z-index: 10;
    }
    .topbar .pill { background:#1f2937; padding:6px 10px; border-radius:8px; font-size: 12px; }
    .geocoder-container {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 350px;
      z-index: 10;
    }
    .search-box {
      background: white;
      border-radius: 8px;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      overflow: hidden;
    }
    .search-input {
      width: 100%;
      height: 40px;
      border: none;
      padding: 0 12px;
      font-size: 14px;
      outline: none;
      box-sizing: border-box;
    }
    .search-results {
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: none;
    }
    .search-result-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
      line-height: 1.4;
    }
    .search-result-item:hover {
      background: #f9fafb;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-name {
      font-weight: 600;
      color: #111827;
    }
    .search-result-address {
      color: #6b7280;
      margin-top: 2px;
    }
    .notice {
      position: absolute; top: 70px; right: 12px; background: #111827; color:#fff; padding: 8px 10px; border-radius: 8px; z-index: 10;
      box-shadow: 0 6px 16px rgba(0,0,0,.2); display:none;
    }
    .btn {
      background:#2563eb; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600;
    }
    .btn.secondary { background:#374151; }
    .legend {
      position:absolute; bottom:60px; left:12px; background:#111827; color:#e5e7eb; padding:10px 12px; border-radius:10px; z-index:10; font-size: 13px;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .legend code { background:#1f2937; padding:1px 6px; border-radius:6px; }
    /* Geocoder container tweak */
    .mapboxgl-ctrl-top-right .mapboxgl-ctrl { margin: 6px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="pill">1) Desenhe uma <b>zona</b> (polígono) no mapa</div>
    <div class="pill">2) Pesquise um endereço no campo da direita</div>
    <button id="btnClear" class="btn secondary" title="Limpar zona">Limpar zona</button>
    <button id="btnExport" class="btn secondary" title="Exportar GeoJSON da zona">Exportar GeoJSON</button>
    <button id="btnImport" class="btn secondary" title="Carregar zona de arquivo">Carregar zona</button>
    <input type="file" id="fileInput" accept=".geojson,.json" style="display: none;">
  </div>

  <div id="map"></div>
  <div id="notice" class="notice"></div>
  <div id="geocoder-container" class="geocoder-container">
    <div class="search-box">
      <input type="text" id="search-input" class="search-input" placeholder="Pesquisar endereço na área demarcada...">
      <div id="search-results" class="search-results"></div>
    </div>
  </div>

  <div class="legend">
    <div><b>Dicas rápidas</b></div>
    <div>• Clique no ícone de <b>polígono</b> para desenhar a zona.</div>
    <div>• Clique nos vértices para <b>editar</b>. Pressione <code>Del</code> para apagar.</div>
    <div>• Use <b>Carregar zona</b> para importar um arquivo GeoJSON.</div>
    <div>• A busca só aceita <b>resultados dentro da zona</b>.</div>
  </div>

  <script>
    // ==== CONFIG ====
    mapboxgl.accessToken = 'pk.eyJ1Ijoic3VwcmVtb3dpbGwiLCJhIjoiY21keHUydHM2MDEzYjJqcHMyNjlkbWVvbyJ9.FTzTaKQvyAZ3ihSNyAYFGg';

    // ==== MAPA ====
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-51.9345, -23.4200], // centro aproximado PR
      zoom: 11
    });

    // Marker p/ resultado
    let resultMarker = null;

    // ==== DRAW (zona) ====
    const Draw = new MapboxDraw({
      displayControlsDefault: false,
      controls: { polygon: true, trash: true },
      defaultMode: 'draw_polygon',
      styles: [
        // fill
        {
          "id": "gl-draw-polygon-fill",
          "type": "fill",
          "filter": ["all", ["==", "$type", "Polygon"], ["!=", "mode", "static"]],
          "paint": { "fill-color": "#3b82f6", "fill-opacity": 0.15 }
        },
        // outline
        {
          "id": "gl-draw-polygon-stroke",
          "type": "line",
          "filter": ["all", ["==", "$type", "Polygon"], ["!=", "mode", "static"]],
          "paint": { "line-color": "#2563eb", "line-width": 2 }
        },
        // vertex
        {
          "id": "gl-draw-polygon-and-line-vertex-halo-active",
          "type": "circle",
          "filter": ["all", ["==", "active", "true"], ["==", "$type", "Point"], ["==", "meta", "vertex"]],
          "paint": { "circle-radius": 7, "circle-color": "#fff" }
        },
        {
          "id": "gl-draw-polygon-and-line-vertex-active",
          "type": "circle",
          "filter": ["all", ["==", "active", "true"], ["==", "$type", "Point"], ["==", "meta", "vertex"]],
          "paint": { "circle-radius": 5, "circle-color": "#2563eb" }
        }
      ]
    });
    map.addControl(Draw, 'top-left');

    // ==== SISTEMA DE BUSCA PERSONALIZADO ====
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    let searchTimeout;

    // Função para buscar endereços
    async function searchAddresses(query) {
      if (!query || query.length < 3) {
        hideSearchResults();
        return;
      }

      try {
        // Constrói a URL da API do Mapbox Geocoding
        const poly = getCurrentZonePolygon();
        console.log('Zona atual na busca:', poly); // Debug
        
        let url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&country=br&language=pt&limit=10`;
        
        // Se há uma zona demarcada, aplica bbox
        if (poly) {
          const bbox = turf.bbox(poly);
          console.log('Bbox calculado:', bbox); // Debug
          url += `&bbox=${bbox.join(',')}`;
        }

        console.log('URL de busca:', url); // Debug
        const response = await fetch(url);
        const data = await response.json();
        console.log('Resultados da API:', data); // Debug
        
        if (data.features && data.features.length > 0) {
          // Filtra resultados que estão dentro da zona (se existir)
          let filteredResults = data.features;
          if (poly) {
            filteredResults = data.features.filter(feature => {
              if (!feature.center) return false;
              const point = turf.point(feature.center);
              const isInside = turf.booleanPointInPolygon(point, poly);
              console.log(`Endereço ${feature.place_name} está dentro da zona: ${isInside}`); // Debug
              return isInside;
            });
          }
          
          console.log('Resultados filtrados:', filteredResults); // Debug
          displaySearchResults(filteredResults);
        } else {
          displayNoResults();
        }
      } catch (error) {
        console.error('Erro na busca:', error);
        displayNoResults();
      }
    }

    // Exibe os resultados da busca
    function displaySearchResults(results) {
      if (results.length === 0) {
        displayNoResults();
        return;
      }

      const html = results.map(feature => {
        const name = feature.text || feature.place_name?.split(',')[0] || 'Endereço';
        const address = feature.place_name || 'Endereço não especificado';
        
        return `
          <div class="search-result-item" data-lng="${feature.center[0]}" data-lat="${feature.center[1]}" data-name="${address}">
            <div class="search-result-name">${name}</div>
            <div class="search-result-address">${address}</div>
          </div>
        `;
      }).join('');

      searchResults.innerHTML = html;
      searchResults.style.display = 'block';

      // Adiciona eventos de clique nos resultados
      searchResults.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const lng = parseFloat(item.dataset.lng);
          const lat = parseFloat(item.dataset.lat);
          const name = item.dataset.name;
          selectAddress(lng, lat, name);
        });
      });
    }

    // Exibe mensagem quando não há resultados
    function displayNoResults() {
      const poly = getCurrentZonePolygon();
      const message = poly ? 
        'Nenhum endereço encontrado na área demarcada' : 
        'Nenhum endereço encontrado';
      
      searchResults.innerHTML = `
        <div class="search-result-item" style="color: #6b7280; cursor: default;">
          ${message}
        </div>
      `;
      searchResults.style.display = 'block';
    }

    // Esconde os resultados
    function hideSearchResults() {
      searchResults.style.display = 'none';
    }

    // Seleciona um endereço
    function selectAddress(lng, lat, name) {
      clearMarker();
      resultMarker = new mapboxgl.Marker({ color: '#2563eb' })
        .setLngLat([lng, lat])
        .addTo(map);
      
      map.flyTo({ 
        center: [lng, lat], 
        zoom: Math.max(map.getZoom(), 16),
        duration: 1000
      });
      
      searchInput.value = name;
      hideSearchResults();
      
      const poly = getCurrentZonePolygon();
      if (poly) {
        showNotice('Endereço selecionado dentro da zona!', 2000);
      } else {
        showNotice('Endereço selecionado!', 2000);
      }
      
      console.log('Endereço selecionado:', { lng, lat, name });
    }

    // Eventos do input de busca
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchAddresses(query);
      }, 300); // Debounce de 300ms
    });

    // Esconde resultados ao clicar fora
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.geocoder-container')) {
        hideSearchResults();
      }
    });

    // Esconde resultados ao pressionar Escape
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideSearchResults();
        searchInput.blur();
      }
    });

    // ==== Helpers UI ====
    const notice = document.getElementById('notice');
    function showNotice(msg, ms = 2800) {
      notice.textContent = msg;
      notice.style.display = 'block';
      clearTimeout(showNotice._t);
      showNotice._t = setTimeout(() => notice.style.display = 'none', ms);
    }

    // ==== ZONA ATUAL ====
    function getCurrentZonePolygon() {
      const fc = Draw.getAll();
      if (!fc || !fc.features || fc.features.length === 0) return null;
      // só considera o primeiro polígono
      const poly = fc.features.find(f => f.geometry && f.geometry.type === 'Polygon');
      return poly || null;
    }

    function clearMarker() {
      if (resultMarker) {
        resultMarker.remove();
        resultMarker = null;
      }
    }

    // ==== CARREGAR ZONA DE ARQUIVO ====
    function loadZoneFromFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Limpa zonas existentes
          Draw.deleteAll();
          clearMarker();
          
          // Verifica se é um FeatureCollection válido
          if (data.type === 'FeatureCollection' && data.features) {
            // Adiciona todas as features que são polígonos
            const polygons = data.features.filter(f => 
              f.geometry && f.geometry.type === 'Polygon'
            );
            
            if (polygons.length > 0) {
              // Adiciona apenas o primeiro polígono para manter a regra de uma zona
              Draw.add(polygons[0]);
              
              // Centraliza o mapa na zona carregada
              const bbox = turf.bbox(polygons[0]);
              map.fitBounds(bbox, { padding: 50 });
              
              // Força a atualização da função de busca
              setTimeout(() => {
                updateGeocoderBBoxFromZone();
              }, 500);
              
              showNotice(`Zona carregada com sucesso! ${polygons.length > 1 ? '(Apenas a primeira zona foi carregada)' : ''} Agora você pode pesquisar endereços na área.`, 4000);
            } else {
              showNotice('Arquivo não contém polígonos válidos.', 3000);
            }
          } 
          // Se é um polígono individual
          else if (data.type === 'Feature' && data.geometry && data.geometry.type === 'Polygon') {
            Draw.add(data);
            
            // Centraliza o mapa na zona carregada
            const bbox = turf.bbox(data);
            map.fitBounds(bbox, { padding: 50 });
            
            // Força a atualização da função de busca
            setTimeout(() => {
              updateGeocoderBBoxFromZone();
            }, 500);
            
            showNotice('Zona carregada com sucesso! Agora você pode pesquisar endereços na área.', 4000);
          }
          // Se é um polígono direto (geometry only)
          else if (data.type === 'Polygon') {
            const feature = {
              type: 'Feature',
              geometry: data,
              properties: {}
            };
            Draw.add(feature);
            
            // Centraliza o mapa na zona carregada
            const bbox = turf.bbox(feature);
            map.fitBounds(bbox, { padding: 50 });
            
            // Força a atualização da função de busca
            setTimeout(() => {
              updateGeocoderBBoxFromZone();
            }, 500);
            
            showNotice('Zona carregada com sucesso! Agora você pode pesquisar endereços na área.', 4000);
          } else {
            showNotice('Formato de arquivo não suportado. Use um arquivo GeoJSON com polígonos.', 4000);
          }
          
        } catch (error) {
          console.error('Erro ao carregar arquivo:', error);
          showNotice('Erro ao processar arquivo. Verifique se é um GeoJSON válido.', 4000);
        }
      };
      
      reader.onerror = function() {
        showNotice('Erro ao ler arquivo.', 3000);
      };
      
      reader.readAsText(file);
    }

    function updateGeocoderBBoxFromZone() {
      const poly = getCurrentZonePolygon();
      if (poly) {
        console.log('Zona detectada para busca:', poly); // Debug
        showNotice('Zona definida. Digite no campo de busca para encontrar endereços na área.', 3000);
      } else {
        console.log('Nenhuma zona detectada'); // Debug
      }
    }

    function clearMarker() {
      if (resultMarker) {
        resultMarker.remove();
        resultMarker = null;
      }
    }

    // ==== Eventos do Draw ====
    map.on('load', () => {
      // Mapa carregado
    });

    map.on('draw.create', () => {
      // Garantir só UMA zona: apaga extras
      const fc = Draw.getAll();
      if (fc.features.length > 1) {
        // mantém o último polígono desenhado
        const lastId = fc.features[fc.features.length - 1].id;
        fc.features.forEach(f => { if (f.id !== lastId) Draw.delete(f.id); });
      }
      updateGeocoderBBoxFromZone();
    });
    map.on('draw.update', updateGeocoderBBoxFromZone);
    map.on('draw.delete', () => {
      showNotice('Zona removida. A busca volta a ser ampla.', 2500);
    });

    // ==== Geocoder: filtra seleção para ficar DENTRO do polígono ====
    // Removido - agora usamos sistema próprio de busca

    // ==== Botões ====
    document.getElementById('btnClear').addEventListener('click', () => {
      Draw.deleteAll();
      clearMarker();
    });

    document.getElementById('btnExport').addEventListener('click', () => {
      const fc = Draw.getAll();
      if (!fc.features.length) {
        showNotice('Nenhuma zona para exportar.');
        return;
      }
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fc, null, 2));
      const a = document.createElement('a');
      a.setAttribute("href", dataStr);
      a.setAttribute("download", "zona.geojson");
      document.body.appendChild(a);
      a.click();
      a.remove();
      showNotice('Arquivo zona.geojson baixado!', 2500);
    });

    document.getElementById('btnImport').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.name.toLowerCase().endsWith('.geojson') || file.name.toLowerCase().endsWith('.json')) {
          loadZoneFromFile(file);
        } else {
          showNotice('Por favor, selecione um arquivo .geojson ou .json', 3000);
        }
        // Limpa o input para permitir selecionar o mesmo arquivo novamente
        e.target.value = '';
      }
    });

    // ==== Qualidade de vida: clique fora para esconder aviso ====
    map.on('click', () => { notice.style.display = 'none'; });

  </script>
</body>
</html>
